```{r}
library(pacman)
p_load(
  here,
  rgdal,
  sf,
  terra,
  ggplot2,
  tmap,
  dplyr,
  gridExtra,
  cowplot,
  ggforce,
  concaveman,
  corrplot
)
df <- read.csv(here("data", "listings.csv"))
```

```{r}
shape <- st_read(here("data", "SF Find Neighborhoods"))
tmap_mode("plot")
```

```{r}
shape_plot <- shape %>% ggplot()+ geom_sf()
scatt<- shape_plot + 
  geom_point(data=df, aes(y=latitude, x=longitude), alpha=0.5, color="red", size=0.1)
groups <- 30
heat<- shape_plot + 
  stat_bin2d(data= df, aes(x=longitude, y=latitude), alpha=0.7, bins = groups) +
  scale_fill_viridis_c(option="C", trans="log") +
  theme(legend.position = "none")
grid.arrange(scatt, heat, ncol=2)
```


```{r}
coloredScatt <- shape_plot +
  geom_point(data=df, aes(y=latitude, x=longitude, color=neighbourhood), alpha=0.5, size=0.1)+
  theme(legend.position = "none")
coloredPolygn <- shape_plot +
  geom_mark_hull(data=df, aes(y=latitude, x=longitude, fill=neighbourhood), expand = 0, radius=0,alpha=0.7, size=0.1, level=0.2) + 
  theme(legend.position = "none")
grid.arrange(coloredScatt, coloredPolygn, ncol=2)
```

```{r}
# price outliers
lower_bound <- quantile(df$price, 0.025)
upper_bound <- quantile(df$price, 0.975)
df %>% filter(price < lower_bound) %>% arrange(price) %>% select(name, price, host_name)
df %>% filter(price > upper_bound) %>% arrange(-price) %>% select(name, price, host_name) # tavlez separar aqueles luxuoses
# há preços a 0
```


```{r}
pricePlot <- ggplot(data=df, aes(price))
pricebox <- pricePlot + 
  geom_boxplot() + 
  coord_flip() +
  xlim(0, 500) # hard to visualize
pricebox
```


```{r}
priceHistPer20 <- pricePlot + # nota-se uma subida a cada +- 50$
  geom_histogram(binwidth=20, aes(y = ..density..)) +
  xlim(0, upper_bound)
priceHistPer50 <- pricePlot +
  geom_histogram(binwidth=50, aes(y = ..density..)) +
  geom_density(color="red") +
  xlim(0, upper_bound)
priceHistPer50
grid.arrange(priceHistPer20, priceHistPer50, ncol=2) 
```


```{r}
scattPriceMap <- shape_plot + 
  geom_point(
    data=df %>% filter(price < upper_bound),
    aes(y=latitude, x=longitude, color=price), alpha=0.5, size=0.1
  ) + scale_color_gradient(low="blue", high="red")
scattPriceMap
```



```{r}
corrplot(df %>% select_if(is.numeric) %>% cor(), method="pie")
```






































