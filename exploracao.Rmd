```{r}
library(pacman)
p_load(
  here,
  rgdal,
  sf,
  terra,
  ggplot2,
  tmap,
  dplyr,
  gridExtra,
  cowplot,
  ggforce,
  concaveman,
  corrplot,
  tidyr,
  car,
  ggridges,
  stats
)
df <- read.csv(here("data", "listings.csv"))
```

```{r}
shape <- st_read(here("data", "SF Planning Neighborhood Groups Map"))
tmap_mode("plot")
```


```{r}
shape_plot <- shape %>% ggplot()+ geom_sf()
scatt<- shape_plot + 
  geom_point(data=df, aes(y=latitude, x=longitude), alpha=0.5, color="red", size=0.1)
groups <- 30
heatLog<- shape_plot + 
  stat_bin2d(data= df, aes(x=longitude, y=latitude), alpha=0.7, bins = groups, interpolate= T) +
  scale_fill_viridis_c(option="C", trans="log") +
  theme(legend.position = "none")
heat <- shape_plot + 
  stat_bin2d(
    data= df, 
    aes(x=longitude, y=latitude), 
    alpha=0.7, bins = groups, interpolate= T, linejoin="round"
    ) +
  scale_fill_viridis_c(option="C")
scatt
grid.arrange(heat, heatLog, ncol=2)
```
```{r}
neighbourhoodss <- df %>%
  group_by(neighbourhood) %>%
  summarise(n = n()) %>%
  arrange(-n)
neighbourhoodss
neighbourhoodss %>% nrow()
```



```{r}
coloredScatt <- shape_plot +
  geom_point(data=df, aes(y=latitude, x=longitude, color=neighbourhood), alpha=0.5, size=0.1)
shape_plot +
  geom_mark_hull(data=df %>% filter(neighbourhood == c("Downtown/Civic Center", "South of Market", "Western Addition", "Mission")), aes(y=latitude, x=longitude, fill=neighbourhood), expand = 0, radius=0,alpha=0.7, size=0.1, level=0.2)
coloredScatt
coloredPolygn
```

```{r}
# price outliers
lower_bound <- quantile(df$price, 0.025)
upper_bound <- quantile(df$price, 0.975)
df %>% filter(price < lower_bound) %>% arrange(price) %>% select(name, price, host_name, neighbourhood)
df %>% filter(price > upper_bound) %>% arrange(-price) %>% select(name, price, host_name, neighbourhood) # talvez separar aqueles luxuosas
# há preços a 0
```


```{r}
pricePlot <- ggplot(data=df, aes(price))
pricebox <- pricePlot + 
  geom_boxplot() + 
  coord_flip()
pricebox # hard to visualize without xlim, but it becomes easier to see the high outliers
pricebox+ xlim(0, 500)
logPriceBox <- ggplot(data=df, aes(log(price)))
logPriceBox + geom_boxplot()
```



```{r}
priceHistPer20 <- pricePlot + # nota-se uma subida a cada +- 50$
  geom_histogram(binwidth=20, aes(y = ..density..)) +
  geom_density(color="red") +
  xlim(0, upper_bound)
priceHistPer50 <- pricePlot +
  geom_histogram(binwidth=50, aes(y = ..density..)) +
  geom_density(color="red") +
  xlim(0, upper_bound)
grid.arrange(priceHistPer20, priceHistPer50, ncol=2) 
```


```{r}
scattPriceMap <- shape_plot + 
  geom_point(
    data=df %>% filter(price < upper_bound),
    aes(y=latitude, x=longitude, color=price), alpha=0.5, size=0.5
  ) +
  scale_color_gradient(low="blue", high="red")
rasterPriceMap <- shape_plot +
  stat_summary_2d(
    data = df, 
    aes(y=latitude, x=longitude, z=price), binwidth=0.005, alpha = 0.8
    ) + 
  scale_fill_viridis_c(option="C", trans="log10") #log(average price
rasterLowerPriceMap <- shape_plot +
  stat_summary_2d(
    data = df %>% filter(price < upper_bound), 
    aes(y=latitude, x=longitude, z=price), binwidth=0.005, alpha = 0.8
    ) + 
  scale_fill_viridis_c(option="D") #non luxury average price

scattHighPriceMap <- shape_plot + 
  geom_point(
    data=df %>% filter(price >= upper_bound),
    aes(y=latitude, x=longitude, color=price), alpha=0.5, size=2, 
  ) +
  scale_color_gradient(low="#FF731D", high="#2A3990")
scattPriceMap
scattHighPriceMap
rasterLowerPriceMap
rasterPriceMap
df %>% arrange(latitude)
```

```{r}
ggplot(data = df, aes(x=price, y= neighbourhood, fill=neighbourhood)) + geom_density_ridges() + theme_ridges() + theme(legend.position = "none") + xlim(0, upper_bound)
df %>% ggplot(aes(y=price, x = forcats::fct_reorder(neighbourhood, price, .fun=median))) + geom_boxplot() + coord_cartesian(ylim=c(0, upper_bound)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
```{r}
df %>% group_by(neighbourhood) %>% summarise(med = median(price))
```



```{r}
cheaperPricesScatt <- shape_plot + 
  geom_point(
    data=df %>% filter(price <= mean(df$price)),
    aes(y=latitude, x=longitude, color=price), alpha=0.5, size=0.5
  ) +
  scale_color_gradient(low="blue", high="red")
MoreExpNotLuxPricesScatt <- shape_plot + 
  geom_point(
    data=df %>% filter(price > mean(df$price) & price < upper_bound),
    aes(y=latitude, x=longitude, color=price), alpha=0.5, size=0.5
  ) +
  scale_color_gradient(low="blue", high="red")
cheaperPricesScatt
MoreExpNotLuxPricesScatt
```

```{r}
df %>%
  group_by(room_type) %>% 
  summarise(
    n = n(), 
    freq = n()/nrow(.),
    averagePrice = mean(price), 
    minPrice = min(price), 
    maxPrice = max(price)
  )
df %>% 
  group_by(neighbourhood) %>% 
  summarise(
    n = n(), 
    freq = n()/nrow(.),
    averagePrice = mean(price), 
    minPrice = min(price), 
    maxPrice = max(price)
  ) %>% arrange(-n)
df %>% 
  group_by(neighbourhood, room_type) %>%
  summarise(
    n = n(), 
    averagePrice = mean(price), 
    minPrice = min(price), 
    maxPrice = max(price)
  ) %>% 
  arrange(neighbourhood, room_type)
df %>% 
  group_by(neighbourhood, room_type) %>%
  summarise(
    n = n(), 
    averagePrice = mean(price), 
    minPrice = min(price), 
    maxPrice = max(price)
  ) %>% 
  arrange(-averagePrice)
df %>% 
  group_by(neighbourhood, room_type) %>%
  filter(price < upper_bound) %>%
  summarise(
    n = n(),
    averagePrice = mean(price), 
    minPrice = min(price), 
    maxPrice = max(price)
  ) %>% 
  arrange(-averagePrice)
```



```{r}
corrplot(df %>% select_if(is.numeric) %>% cor(), method="pie")
mean(df$price)
cor(df %>%
select(latitude, longitude,
price, reviews_per_month,
availability_365,
number_of_reviews_ltm))
df %>% filter(is.na(reviews_per_month))
corrplot(df %>% select_if(is.numeric) %>% cor(method= 'kendall'), method="pie")
```


```{r}
md1 <- lm(price ~ number_of_reviews + minimum_nights, df)
summary(md1)
mean(residuals(md1))

bgtest(price ~ number_of_reviews + minimum_nights)
```

```{r}
md2 <- lm(reviews_per_month ~ number_of_reviews + minimum_nights, df)

```

```{r}
df2 <- df %>% select(price, minimum_nights, number_of_reviews, reviews_per_month, calculated_host_listings_count, number_of_reviews_ltm)

scatterplotMatrix(df2, smooth = FALSE, main="Scatter Plot Matrix")

```



```{r}
df %>% count(minimum_nights)
df %>% select(price, neighbourhood, latitude, longitude, room_type) %>%
  mutate(isLuxuary = price > quantile(df$price, 0.975) + 20, logPrice = log(price), )
df %>% arrange(-price) %>% select(name, price, host_name)
```



```{r}
# dummies
df %>% select(neighbourhood, latitude, longitude, room_type, price) %>%
  mutate(
    logPrice = log(price), 
    isFromSuperDenseGroup = ifelse(neighbourhood %in%  )
  )
```































